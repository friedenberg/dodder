#!/bin/bash -e

# forces sorting to place `_` before `a`
export LC_ALL=C

get_package_dependencies() {
  local pkg_path="$1"
  local base_module="code.linenisgreat.com/dodder/go"
  
  go list -f '{{range .Imports}}{{.}}{{"\n"}}{{end}}' "./$pkg_path" 2>/dev/null |
    grep -E "^$base_module/src/\w+/\w+\$" |
    sed "s|^$base_module/src/||" |
    sort -u |
    xargs -L1 printf "%s -> %s\n" "${pkg_path#src/}" |
    grep -v -- '-> $' || true
}

while IFS= read -r -d '' package; do
  get_package_dependencies "$package"
done < <(find src -mindepth 2 -maxdepth 2 -type d -print0 | sort -z)
